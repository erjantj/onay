JOB={Config:{Multiple:!0,DecodeFormats:["Code128"],ForceUnique:!0,LocalizationFeedback:!1,SkipOrientation:!1},SupportedFormats:["Code128","Code93","Code39","EAN-13","2Of5","Inter2Of5","Codabar"],ScanCanvas:null,ScanContext:null,SquashCanvas:document.createElement("canvas"),ImageCallback:null,StreamCallback:null,LocalizationCallback:null,Stream:null,DecodeStreamActive:!1,Decoded:[],DecoderWorker:new Worker("dist/js/DecoderWorker.js"),OrientationCallback:null,Init:function(){JOB.ScanCanvas=JOB.FixCanvas(document.createElement("canvas")),JOB.ScanCanvas.width=640,JOB.ScanCanvas.height=480,JOB.ScanContext=JOB.ScanCanvas.getContext("2d");var e=document.createElement("script");e.src="dist/js/exif.js",e.type="text/javascript",document.getElementsByTagName("head").item(0).appendChild(e)},SetRotationSkip:function(e){JOB.Config.SkipOrientation=e},SetImageCallback:function(e){JOB.ImageCallback=e},SetStreamCallback:function(e){JOB.StreamCallback=e},SetLocalizationCallback:function(e){JOB.LocalizationCallback=e,JOB.Config.LocalizationFeedback=!0},SwitchLocalizationFeedback:function(e){JOB.Config.LocalizationFeedback=e},DecodeSingleBarcode:function(){JOB.Config.Multiple=!1},DecodeMultiple:function(){JOB.Config.Multiple=!0},SetDecodeFormats:function(e){JOB.Config.DecodeFormats=[];for(var a=0;a<e.length;a++)-1!=JOB.SupportedFormats.indexOf(e[a])&&JOB.Config.DecodeFormats.push(e[a]);0==JOB.Config.DecodeFormats.length&&(JOB.Config.DecodeFormats=JOB.SupportedFormats.slice())},SkipFormats:function(e){for(var a=0;a<e.length;a++){var t=JOB.Config.DecodeFormats.indexOf(e[a]);t>=0&&JOB.Config.DecodeFormats.splice(t,1)}},AddFormats:function(e){for(var a=0;a<e.length;a++)-1!=JOB.SupportedFormats.indexOf(e[a])&&-1==JOB.Config.DecodeFormats.indexOf(e[a])&&JOB.Config.DecodeFormats.push(e[a])},JOBImageCallback:function(e){if("localization"==e.data.success)return void(JOB.Config.LocalizationFeedback&&JOB.LocalizationCallback(e.data.result));if("orientationData"==e.data.success)return void JOB.OrientationCallback(e.data.result);for(var a=[],t=0;t<e.data.result.length;t++)-1!=JOB.Decoded.indexOf(e.data.result[t].Value)&&0!=JOB.Config.ForceUnique||(a.push(e.data.result[t]),JOB.Config.ForceUnique&&JOB.Decoded.push(e.data.result[t].Value));JOB.ImageCallback(a),JOB.Decoded=[]},JOBStreamCallback:function(e){if("localization"==e.data.success)return void(JOB.Config.LocalizationFeedback&&JOB.LocalizationCallback(e.data.result));if(e.data.success&&JOB.DecodeStreamActive){for(var a=[],t=0;t<e.data.result;t++)-1!=JOB.Decoded.indexOf(e.data.result[t].Value)&&0!=JOB.ForceUnique||(a.push(e.data.result[t]),JOB.ForceUnique&&JOB.Decoded.push(e.data.result[t].Value));a.length>0&&JOB.StreamCallback(a)}JOB.DecodeStreamActive&&(JOB.ScanContext.drawImage(JOB.Stream,0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height),JOB.DecoderWorker.postMessage({scan:JOB.ScanContext.getImageData(0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height).data,scanWidth:JOB.ScanCanvas.width,scanHeight:JOB.ScanCanvas.height,multiple:JOB.Config.Multiple,decodeFormats:JOB.Config.DecodeFormats,cmd:"normal",rotation:1})),JOB.DecodeStreamActive||(JOB.Decoded=[])},DecodeImage:function(e){if(e instanceof Image||e instanceof HTMLImageElement)if(e.exifdata=!1,e.complete)JOB.Config.SkipOrientation?JOB.JOBDecodeImage(e,1,""):EXIF.getData(e,function(e){var a=EXIF.getTag(e,"Orientation"),t=EXIF.getTag(e,"SceneCaptureType");"number"!=typeof a&&(a=1),JOB.JOBDecodeImage(e,a,t)});else{var a=new Image;a.onload=function(){JOB.Config.SkipOrientation?JOB.JOBDecodeImage(a,1,""):EXIF.getData(this,function(e){var a=EXIF.getTag(e,"Orientation"),t=EXIF.getTag(e,"SceneCaptureType");"number"!=typeof a&&(a=1),JOB.JOBDecodeImage(e,a,t)})},a.src=e.src}else{var a=new Image;a.onload=function(){JOB.Config.SkipOrientation?JOB.JOBDecodeImage(a,1,""):EXIF.getData(this,function(e){var a=EXIF.getTag(e,"Orientation"),t=EXIF.getTag(e,"SceneCaptureType");"number"!=typeof a&&(a=1),JOB.JOBDecodeImage(e,a,t)})},a.src=e}},DecodeStream:function(e){JOB.Stream=e,JOB.DecodeStreamActive=!0,JOB.DecoderWorker.onmessage=JOB.JOBStreamCallback,JOB.ScanContext.drawImage(e,0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height),JOB.DecoderWorker.postMessage({scan:JOB.ScanContext.getImageData(0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height).data,scanWidth:JOB.ScanCanvas.width,scanHeight:JOB.ScanCanvas.height,multiple:JOB.Config.Multiple,decodeFormats:JOB.Config.DecodeFormats,cmd:"normal",rotation:1})},StopStreamDecode:function(){JOB.DecodeStreamActive=!1,JOB.Decoded=[]},JOBDecodeImage:function(e,a,t){8==a||6==a?"Landscape"==t&&e.width>e.height?(a=1,JOB.ScanCanvas.width=640,JOB.ScanCanvas.height=480):(JOB.ScanCanvas.width=480,JOB.ScanCanvas.height=640):(JOB.ScanCanvas.width=640,JOB.ScanCanvas.height=480),JOB.DecoderWorker.onmessage=JOB.JOBImageCallback,JOB.ScanContext.drawImage(e,0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height),JOB.Orientation=a,JOB.DecoderWorker.postMessage({scan:JOB.ScanContext.getImageData(0,0,JOB.ScanCanvas.width,JOB.ScanCanvas.height).data,scanWidth:JOB.ScanCanvas.width,scanHeight:JOB.ScanCanvas.height,multiple:JOB.Config.Multiple,decodeFormats:JOB.Config.DecodeFormats,cmd:"normal",rotation:a,postOrientation:JOB.PostOrientation})},DetectVerticalSquash:function(e){var a=e.naturalHeight,t=JOB.SquashCanvas;t.width=1,t.height=a;var n=t.getContext("2d");n.drawImage(e,0,0);try{var i=n.getImageData(0,0,1,a).data}catch(c){return console.log("Cannot check verticalSquash: CORS?"),1}for(var o=0,l=a,r=a;r>o;){var s=i[4*(r-1)+3];0===s?l=r:o=r,r=l+o>>1}var d=r/a;return 0===d?1:d},FixCanvas:function(e){var a=e.getContext("2d"),t=a.drawImage;return a.drawImage=function(e,n,i,c,o,l,r,s,d){var O=1;e&&"IMG"==e.nodeName&&(O=JOB.DetectVerticalSquash(e),c||(c=e.naturalWidth),o||(o=e.naturalHeight)),9==arguments.length?t.call(a,e,n,i,c,o,l,r,s,d/O):"undefined"!=typeof c?t.call(a,e,n,i,c,o/O):t.call(a,e,n,i)},e}};var OnayApp={$addTicketButton:$(".js-add-ticket-button"),$addTicketFile:$(".js-add-ticket-file"),$ticketNumber:$(".js-ticket-number"),$displayImage:document.createElement("img"),$loadingIcon:$(".js-loading-icon"),$infoText:$(".js-info-text"),$getTicketBalanceButton:$(".js-get-ticket-balance"),$ticketBalance:$(".js-ticket-balance"),ticketNumberVisibleClass:"content__info__ticket-number--visible",loadingIconVisibleClass:"content__loading--visible",getTicketBalanceButtonVisibleClass:"content__add-ticket__balance--visible",ticketBalanceVisibleClass:"content__info__ticket-balance--visible",requestUrl:"getbalance.php",errorMessage:'Мы не смогли узнать билет :( <br /> Попробуйте еще раз"',init:function(){OnayApp.bindListeners(),OnayApp.initJOB(),"undefined"!=typeof Storage&&localStorage.ticketNumber&&(OnayApp.$ticketNumber.html(localStorage.ticketNumber),OnayApp.$infoText.fadeOut(),OnayApp.showTicketNumber(),OnayApp.showGetTicketBalanceButton())},bindListeners:function(){OnayApp.$addTicketButton.click(OnayApp.addTicketButtonClick),OnayApp.$getTicketBalanceButton.click(OnayApp.getTicketBalanceButtonClick),OnayApp.$addTicketFile.change(OnayApp.addTicketFileChange)},initJOB:function(){JOB.Init(),JOB.SetImageCallback(function(e){if(e.length>0){var a=e[0].Value;19==a.length&&$.isNumeric(a)?("undefined"!=typeof Storage&&(localStorage.ticketNumber=a),OnayApp.$ticketNumber.html(a),OnayApp.$infoText.fadeOut(),OnayApp.showTicketNumber(),OnayApp.showGetTicketBalanceButton()):OnayApp.showError(OnayApp.errorMessage)}else 0===e.length&&OnayApp.showError(OnayApp.errorMessage);OnayApp.hideloadingIcon()})},showTicketNumber:function(){OnayApp.$ticketNumber.addClass(OnayApp.ticketNumberVisibleClass)},hideTicketNumber:function(){OnayApp.$ticketNumber.removeClass(OnayApp.ticketNumberVisibleClass)},showloadingIcon:function(){OnayApp.$loadingIcon.addClass(OnayApp.loadingIconVisibleClass)},hideloadingIcon:function(){OnayApp.$loadingIcon.removeClass(OnayApp.loadingIconVisibleClass)},showGetTicketBalanceButton:function(){OnayApp.$getTicketBalanceButton.addClass(OnayApp.getTicketBalanceButtonVisibleClass)},hideGetTicketBalanceButton:function(){OnayApp.$getTicketBalanceButton.removeClass(OnayApp.getTicketBalanceButtonVisibleClass)},showTicketBalance:function(){OnayApp.$ticketBalance.addClass(OnayApp.ticketBalanceVisibleClass)},hideTicketBalance:function(){OnayApp.$ticketBalance.removeClass(OnayApp.ticketBalanceVisibleClass)},addTicketButtonClick:function(e){OnayApp.$addTicketFile.trigger("click")},getTicketBalanceButtonClick:function(e){OnayApp.showloadingIcon(),$.ajax({url:OnayApp.requestUrl,data:{pan:OnayApp.$ticketNumber.html()},dataType:"json",success:function(e){if(OnayApp.hideloadingIcon(),e.hasOwnProperty("balance")){var a=e.balance/100;OnayApp.$ticketBalance.html("Ваш баланс: "+a+" тенге"),OnayApp.showTicketBalance()}else OnayApp.showError(OnayApp.error)},error:function(){OnayApp.showError(OnayApp.error)}})},showError:function(e){OnayApp.hideTicketNumber(),OnayApp.hideGetTicketBalanceButton(),OnayApp.hideTicketBalance(),OnayApp.$infoText.fadeIn(),OnayApp.$infoText.html(e)},addTicketFileChange:function(e){var a=e.target.files;if(a&&a.length>0){OnayApp.showloadingIcon(),OnayApp.hideTicketBalance(),file=a[0];try{var t=window.URL||window.webkitURL;OnayApp.$displayImage.onload=function(e){OnayApp.$ticketNumber.innerHTML="",JOB.DecodeImage(OnayApp.$displayImage),t.revokeObjectURL(OnayApp.$displayImage.src)},OnayApp.$displayImage.src=t.createObjectURL(file)}catch(n){try{var i=new FileReader;i.onload=function(e){OnayApp.$displayImage.onload=function(e){OnayApp.$ticketNumber.innerHTML="",JOB.DecodeImage(OnayApp.$displayImage)},OnayApp.$displayImage.src=e.target.result},i.readAsDataURL(file)}catch(n){OnayApp.hideloadingIcon(),OnayApp.showError("Ваше устройство не поддерживает это приложение")}}}}};OnayApp.init();